<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spaced Repetition Study Tracker</title>
    
    <style>
        :root {
            /* Modern Color Palette with purple/indigo theme */
            --bg-body: #f8fafc; /* Light background */
            --bg-content: #ffffff;
            --primary-dark: #4c1d95; /* Deep purple */
            --primary-accent: #7c3aed; /* Vibrant purple */
            --primary-accent-light: #ede9fe; /* Light purple background */
            --primary-text: #1e293b; /* Dark text */
            --secondary-text: #64748b; /* Gray text */
            --border-color: #e2e8f0;
            --danger-color: #ef4444;
            --danger-hover: #dc2626;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --info-color: #3b82f6; /* Blue for 'Edit' */
            --info-hover: #2563eb; /* Darker blue */
            --nav-link: #cbd5e1;
            --nav-link-active: #ffffff;
            --completed-text: #94a3b8;
            --overdue-color: #ef4444;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --heatmap-due: #fee2e2; /* Light red for due items */
            --heatmap-due-high: #fecaca; /* Darker red for high intensity */
        }

        /* --- Base & Mobile Styles --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--primary-text);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* --- Header / Progress Bar --- */
        .app-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-accent));
            color: var(--nav-link-active);
            padding: 15px 15px;
            box-shadow: var(--card-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .header-title-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title-row h1 {
            font-size: 1.35rem;
            margin: 0;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .menu-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--nav-link-active);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
            flex-shrink: 0;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        
        .menu-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .global-stats-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .global-stats {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .global-stats-text {
            font-size: 0.85rem;
            color: var(--nav-link);
            font-weight: 500;
        }
        
        .global-progress-bar {
            width: 100%;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
        }

        .global-progress-bar-inner {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 5px;
            transition: width 0.3s ease;
            box-shadow: 0 0 5px rgba(16, 185, 129, 0.5);
        }
        
        .global-streak-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--nav-link-active);
            background: rgba(0, 0, 0, 0.1);
            padding: 6px 10px;
            border-radius: 6px;
        }
        
        /* --- Navigation Tabs (Mobile) --- */
        .app-nav {
            background-color: var(--primary-dark);
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            padding: 0 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0; /* Fallback */
        }
        
        @supports (position: sticky) or (position: -webkit-sticky) {
            .app-nav {
                position: sticky;
                top: 79px; /* Adjust this value based on header height */
                z-index: 99;
            }
            
            @media (min-width: 600px) {
                .app-nav {
                    top: 72px; 
                }
            }
        }
        
        .nav-tab {
            font-family: inherit;
            font-size: 0.95rem;
            font-weight: 600;
            background: transparent;
            border: none;
            color: var(--nav-link);
            padding: 12px 10px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            position: relative;
            flex-shrink: 0;
        }

        .nav-tab.active {
            color: var(--nav-link-active);
            border-bottom-color: var(--primary-accent);
        }
        
        .nav-tab:hover {
            color: var(--nav-link-active);
        }

        .count-bubble {
            position: absolute;
            top: 5px;
            right: 0px;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: none;
            place-content: center;
            line-height: 18px;
            text-align: center;
            padding: 1px;
        }
        
        #today-count-bubble { background-color: var(--danger-color); }
        #backlog-count-bubble { background-color: var(--warning-color); }
        
        /* --- Main Content --- */
        .container {
            max-width: 900px;
            margin: 15px auto;
            padding: 0 10px;
        }

        .tab-content {
            background-color: var(--bg-content);
            padding: 15px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 10px;
            display: none;
            transition: all 0.3s ease;
        }

        .tab-content.active { 
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-size: 1.5rem;
            color: var(--primary-text);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            font-weight: 700;
        }
        
        /* --- Form (Mobile-first, single column) --- */
        #session-form, #edit-session-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .form-group {
            width: 100%;
        }
        
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-dark);
            display: block;
            font-size: 0.95rem;
        }

        .form-group input, .form-group textarea, button[type="submit"] {
            padding: 12px 15px;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            width: 100%;
            transition: all 0.2s;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-accent);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        
        button[type="submit"], #save-edit-btn {
            background: linear-gradient(135deg, var(--primary-accent), var(--primary-dark));
            color: white;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(124, 58, 237, 0.3);
        }
        
        button[type="submit"]:hover, #save-edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(124, 58, 237, 0.4);
        }

        /* --- Calendar Styling --- */
        .calendar-container {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            background-color: var(--primary-accent-light);
            box-shadow: var(--card-shadow);
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .cal-nav-btn {
            background-color: var(--primary-accent);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cal-nav-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .calendar-header h3 {
            font-size: 1.2rem;
            color: var(--primary-text);
            font-weight: 700;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .calendar-day-name {
            font-size: 0.75rem;
            padding: 8px 0;
            font-weight: 600;
            color: var(--secondary-text);
            background-color: #f7f7f7;
        }

        .calendar-date-cell {
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--primary-text);
            position: relative;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .calendar-date-cell:hover {
            background-color: var(--primary-accent-light);
        }
        
        .calendar-date-cell.today {
            border: 2px solid var(--primary-accent);
            background-color: var(--primary-accent-light);
            font-weight: 700;
        }

        .calendar-date-cell.completed {
            background-color: var(--success-color);
            color: white !important;
            font-weight: 700;
        }
        
        .calendar-date-cell.due-revision::after {
            content: '';
            position: absolute;
            bottom: 3px;
            width: 5px;
            height: 5px;
            background-color: var(--danger-color);
            border-radius: 50%;
        }
        
        .calendar-date-cell.due-intensity-high {
            background-color: var(--heatmap-due);
        }
        .calendar-date-cell.due-intensity-high::after {
             width: 8px;
             height: 8px;
             background-color: var(--danger-hover);
        }
        
        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            color: var(--secondary-text);
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 5px;
            border: 1px solid var(--border-color);
        }
        
        .legend-color.completed { background-color: var(--success-color); border-color: var(--success-color); }
        .legend-color.due::after {
            content: '';
            display: block;
            width: 5px;
            height: 5px;
            background-color: var(--danger-color);
            border-radius: 50%;
            margin: 3px;
        }

        /* --- Review Items & Sessions (General styling) --- */
        .review-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: white;
            box-shadow: var(--card-shadow);
            transition: all 0.2s;
        }
        
        .review-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }
        
        .review-item-info {
             overflow: hidden; /* Prevent long text from breaking layout */
             margin-right: 10px;
        }
        
        .review-item-info strong {
            font-size: 1rem;
            color: var(--primary-accent);
            display: block;
            margin-bottom: 5px;
        }
        
        .review-item-info .topic-name {
            font-weight: 600;
            color: var(--primary-text);
            margin-bottom: 5px;
            word-wrap: break-word; /* Wrap long topics */
        }
        
        .review-item-info .review-date {
            font-size: 0.85rem;
            color: var(--secondary-text);
        }
        
        .review-item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0; /* Stop action buttons from shrinking */
        }
        
        .review-item-actions input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--success-color);
        }
        
        .details-btn {
            background-color: var(--primary-accent-light);
            color: var(--primary-accent);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }
        
        .details-btn:hover {
            background-color: var(--primary-accent);
            color: white;
        }

        .review-item.overdue {
            border-left: 5px solid var(--overdue-color);
        }
        
        .review-item.critical {
            border: 2px solid var(--danger-color);
            background-color: #fef2f2;
        }
        
        /* --- Data Management Modal Styles --- */
        /* Export area removed in favor of file download */
        
        /* NEW button for JSON export */
        #export-json-btn {
            background-color: var(--primary-accent);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        #export-json-btn:hover {
            background-color: var(--primary-dark);
        }

        #import-data-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 0; /* Adjusted for file input */
            transition: all 0.2s;
            font-weight: 600;
        }
        
        #import-data-btn:hover {
            background-color: var(--danger-hover);
        }
        
        .modal-body h4 {
            font-size: 1.2rem;
            color: var(--primary-dark);
            margin-top: 20px;
            margin-bottom: 5px;
        }
        
        /* --- Desktop/Tablet Modernized Styles --- */
        @media (min-width: 600px) {
            
            .header-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            .global-stats-container {
                min-width: 350px;
                gap: 8px;
            }
            .global-streak-stats {
                font-size: 0.9rem;
                padding: 8px 12px;
            }
            
            #session-form {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            #form-group-subject { grid-column: 1 / 3; }
            #form-group-topic { grid-column: 1 / 3; }
            #form-group-notes { grid-column: 1 / 3; }
            #form-group-file-link { grid-column: 1 / 3; }
            #form-group-button { grid-column: 1 / 3; }
            
            .container {
                padding: 0 20px;
            }
            
            .tab-content {
                padding: 25px;
            }
            
            h2 {
                font-size: 1.75rem;
                padding-bottom: 10px;
                border-bottom: 2px solid var(--border-color);
            }
            
            .review-item {
                padding: 15px;
                box-shadow: var(--card-shadow);
            }
        }
        
        /* --- General Shared Styles (Modals) --- */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0, 0, 0, 0.5); 
            animation: fadeIn 0.3s;
        }
        .modal-content { 
            background-color: var(--bg-content); 
            margin: 10% auto; 
            padding: 25px; 
            border: 1px solid var(--border-color); 
            width: 90%; 
            max-width: 500px; 
            border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 15px; 
            margin-bottom: 20px; 
        }
        .modal-header h3 { 
            font-size: 1.5rem; 
            color: var(--primary-accent); 
            margin: 0; 
            line-height: 1.3; 
            font-weight: 700;
        }
        .close-btn { 
            color: var(--secondary-text); 
            font-size: 2rem; 
            font-weight: bold; 
            line-height: 1; 
            cursor: pointer; 
            padding: 0 5px; 
            border: none; 
            background: transparent; 
            transition: color 0.2s;
        }
        .close-btn:hover {
            color: var(--primary-text);
        }
        .modal-body p strong { 
            color: var(--primary-text); 
            display: block; 
            margin-bottom: 3px; 
        }
        .modal-body pre { 
            background-color: var(--bg-body); 
            padding: 10px; 
            border-radius: 8px; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            font-family: inherit; 
            max-height: 200px; 
            overflow-y: auto; 
        }
        .empty-state { 
            color: var(--secondary-text); 
            text-align: center; 
            padding: 40px 20px; 
            border: 2px dashed var(--border-color); 
            border-radius: 12px; 
            background-color: #f9fafb; 
            font-style: italic;
        }
        
        /* --- Welcome Banner --- */
        .welcome-banner {
            display: flex;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-accent-light), #e0e7ff);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: var(--card-shadow);
        }
        
        .welcome-banner::before {
            content: '';
            display: block;
            width: 4px;
            height: 2.5rem;
            background: linear-gradient(to bottom, var(--primary-accent), var(--primary-dark));
            border-radius: 2px;
            margin-right: 15px;
        }
        
        .welcome-banner p {
            font-size: 1.1rem;
            font-style: italic;
            color: var(--primary-dark);
            font-weight: 500;
        }
        
        /* --- All Sessions Card --- */
        .session-card {
            background-color: var(--bg-content);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-accent);
            transition: all 0.2s;
        }
        
        .session-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--card-shadow-hover);
        }
        
        .session-card.mastered {
            border-left-color: var(--success-color);
            background-color: #f0fdf4; /* Light green background */
        }
        
        .session-card h3 {
            font-size: 1.25rem;
            margin-bottom: 8px;
            color: var(--primary-dark);
            font-weight: 700;
        }
        .session-card p {
            font-size: 0.95rem;
            margin-bottom: 5px;
            color: var(--secondary-text);
            word-wrap: break-word; /* Wrap notes */
        }
        .session-card h4 {
            font-size: 1rem;
            margin-top: 10px;
            margin-bottom: 5px;
            color: var(--primary-text);
            font-weight: 600;
        }
        .session-card .progress-bar {
            width: 100%;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .session-card .progress-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), #34d399);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .session-card .session-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }
        
        /* NEW: Wrapper for footer buttons */
        .session-footer > div {
            display: flex;
            gap: 10px;
        }
        
        .session-card .delete-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .session-card .delete-btn:hover {
            background-color: var(--danger-hover);
            transform: translateY(-1px);
        }
        
        /* NEW: Edit Button Style */
        .session-card .edit-btn {
            background-color: var(--info-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        .session-card .edit-btn:hover {
            background-color: var(--info-hover);
            transform: translateY(-1px);
        }
        
        .completed-reviews-list {
            list-style: none;
            padding-left: 0;
            margin-top: 5px;
            font-size: 0.9rem;
        }
        .completed-reviews-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            color: var(--secondary-text);
            border-bottom: 1px solid var(--border-color);
        }
        .completed-reviews-list li:last-child {
            border-bottom: none;
        }
        .completed-reviews-list li span {
            color: var(--success-color);
            font-weight: 500;
        }
        .completed-reviews-list .undo-btn {
            background: none;
            border: none;
            color: var(--secondary-text);
            font-size: 0.8rem;
            cursor: pointer;
            text-decoration: underline;
            transition: color 0.2s;
        }
        
        .completed-reviews-list .undo-btn:hover {
            color: var(--primary-accent);
        }
        
        .subject-group-header {
            font-size: 1.5rem;
            color: var(--primary-dark);
            margin-top: 25px;
            margin-bottom: 10px;
            border-bottom: 2px solid var(--primary-accent);
            padding-bottom: 5px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .subject-scoreboard {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-dark);
            background-color: var(--primary-accent-light);
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        /* --- Clear Data Button --- */
        #clear-data-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.2s;
            font-weight: 600;
        }
        
        #clear-data-btn:hover {
            background-color: var(--danger-hover);
        }

        /* --- Time Logger Styles --- */
        .time-logger-container {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px solid var(--border-color);
        }
        .time-logger-container h4 {
            font-size: 1.2rem;
            color: var(--primary-dark);
            margin-bottom: 5px;
        }
        .time-logger-container p {
            font-size: 0.9rem;
            color: var(--secondary-text);
            margin-bottom: 10px;
        }
        .time-logger-inputs {
            display: flex;
            gap: 10px;
        }
        .time-logger-inputs input[type="number"] {
            flex-grow: 1;
            padding: 10px;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .time-logger-inputs button {
            background: var(--primary-accent);
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .time-logger-inputs button:hover {
            background: var(--primary-dark);
        }
        
        /* --- Backlog Section Headers --- */
        .backlog-section-header {
            font-size: 1.2rem;
            color: var(--primary-text);
            margin-top: 20px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .backlog-section-header.critical {
            color: var(--danger-color);
            font-weight: 700;
        }
        .backlog-section-header.standard {
            color: var(--warning-color);
            font-weight: 700;
        }
        
        /* --- Daily Schedule Modal Banner --- */
        .schedule-summary-banner {
            display: none; /* Hidden by default */
            padding: 12px;
            margin-bottom: 15px;
            background-color: var(--primary-accent-light);
            color: var(--primary-dark);
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            border-left: 4px solid var(--primary-accent);
        }
        .schedule-summary-banner strong {
            color: var(--primary-dark);
            font-weight: 700;
        }
        
        /* NEW: Subject Filter Dropdown */
        .filter-container {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-container label {
            font-weight: 600;
            color: var(--primary-text);
            font-size: 0.95rem;
            flex-shrink: 0;
        }
        .filter-container select {
            padding: 8px 12px;
            font-size: 0.95rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: white;
            flex-grow: 1;
            max-width: 400px;
        }

    </style>
</head>
<body>

    <header class="app-header">
        <div class="header-content">
            <div class="header-title-row">
                <h1>ðŸ§  Study Tracker</h1>
                <button class="menu-button" id="data-management-btn" title="Data Management">&#8942;</button>
            </div>
            
            <div class="global-stats-container">
                <div class="global-stats">
                    <span class="global-stats-text" id="global-stats-text">Total Progress: 0 / 0 Reviews</span>
                    <div class="global-progress-bar">
                        <div class="global-progress-bar-inner" id="global-progress-bar-inner" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="global-streak-stats" id="global-streak-stats">
                    <span id="streak-counter">ðŸ”¥ Streak: 0</span>
                    <span id="daily-goal-counter">Reviews Today: 0 / 3</span>
                    <span id="total-time-counter">ðŸ•’ Total Study Time: 0.0 Hours</span>
                </div>
            </div>
            
        </div>
    </header>

    <nav class="app-nav">
        <button class="nav-tab active" data-tab="today">
            Today
            <span class="count-bubble" id="today-count-bubble"></span>
        </button>
        <button class="nav-tab" data-tab="backlog">
            Backlog
            <span class="count-bubble" id="backlog-count-bubble"></span>
        </button>
        <button class="nav-tab" data-tab="attendance">
            Attendance
        </button>
        <button class="nav-tab" data-tab="add">Add Session</button>
        <button class="nav-tab" data-tab="all">All Sessions</button>
    </nav>

    <main class="container">
        
        <section id="tab-today" class="tab-content active">
            <h2>Today's Reviews</h2>
            <div id="today-reviews-container">
                </div>
            
            <div class="time-logger-container">
                <h4>Log Your Study Time</h4>
                <p>Logged for today (<span id="today-date-log"></span>): <strong id="logged-time-today">0</strong> minutes</p>
                <div class="time-logger-inputs">
                    <input type="number" id="daily-time" placeholder="Add minutes..." min="1">
                    <button id="log-time-btn">Log Time</button>
                </div>
            </div>
        </section>
        
        <section id="tab-backlog" class="tab-content">
            <h2>Backlog (Missed Reviews)</h2>
            
            <h3 class="backlog-section-header critical">ðŸš¨ Critical Open Loops (Start Here)</h3>
            <div id="backlog-critical-container">
                </div>
            
            <h3 class="backlog-section-header standard">ðŸŸ¡ Standard Backlog</h3>
            <div id="backlog-standard-container">
                </div>
        </section>

        <section id="tab-attendance" class="tab-content">
            <h2>My Attendance & Revisions</h2>
            <p style="margin-bottom: 15px; font-size: 0.95rem; color: var(--secondary-text);">
                Click any date to see the day's scheduled revisions.
            </p>
            <div class="calendar-container" id="calendar-container">
                <div class="calendar-header">
                    <button id="cal-prev-btn" class="cal-nav-btn">&lt; Prev</button>
                    <h3 id="cal-month-year">October 2025</h3>
                    <button id="cal-next-btn" class="cal-nav-btn">Next &gt;</button>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                    <div class="calendar-day-name">Mon</div>
                    <div class="calendar-day-name">Tue</div>
                    <div class="calendar-day-name">Wed</div>
                    <div class="calendar-day-name">Thu</div>
                    <div class="calendar-day-name">Fri</div>
                    <div class="calendar-day-name">Sat</div>
                    <div class="calendar-day-name">Sun</div>
                </div>
                
                <div class="calendar-legend">
                    <div class="legend-item">
                        <span class="legend-color completed"></span>Completed
                    </div>
                    <div class="legend-item">
                        <span class="legend-color due"></span>Revision Due
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-add" class="tab-content">
            <div class="welcome-banner">
                <p>"Believe you can and you're halfway there."</p>
            </div>
            
            <h2>Start a New Session</h2>
            <form id="session-form">
                <div class="form-group" id="form-group-subject">
                    <label for="subject">1. Select Subject</label>
                    <input type="text" id="subject" list="subject-list" placeholder="e.g., 'Math' or 'History'" required>
                    <datalist id="subject-list"></datalist>
                </div>
                <div class="form-group" id="form-group-topic">
                    <label for="topic">2. Select Topic</label>
                    <input type="text" id="topic" placeholder="e.g., 'Chapter 3: Neural Networks'" required>
                </div>
                <div class="form-group" id="form-group-notes">
                    <label for="notes">3. Notes (Optional)</label>
                    <textarea id="notes" placeholder="e.g., 'Key concepts: backpropagation, activation functions'"></textarea>
                </div>
                <div class="form-group" id="form-group-file-link">
                    <label for="file-link">4. File/PDF Link (Optional)</label>
                    <input type="text" id="file-link" placeholder="e.g., 'https://.../my-notes.pdf' or 'file:///C:/...'">
                </div>
                <div class="form-group" id="form-group-date">
                    <label for="initial-date">5. Start Date</label>
                    <input type="date" id="initial-date" required>
                </div>
                <div class="form-group" id="form-group-button">
                    <button type="submit">Start Tracking Session</button>
                </div>
            </form>
        </section>

        <section id="tab-all" class="tab-content">
            <h2>All Sessions by Subject</h2>
            
            <div class="filter-container">
                <label for="subject-filter-dropdown">Filter by Subject:</label>
                <select id="subject-filter-dropdown">
                    <option value="all">Show All</option>
                    </select>
            </div>
            
            <div id="all-sessions-container">
                </div>
        </section>

    </main>
    
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-topic"></h3>
                <button class="close-btn" data-modal="details-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Notes:</strong></p>
                <pre id="modal-notes"></pre>
                
                <p style="margin-top: 15px;"><strong>File Link:</strong></p>
                <div id="modal-file-link"></div>
                
                <p style="margin-top: 15px;">
                    <strong>Started:</strong> 
                    <span id="modal-start-date"></span>
                </p>
            </div>
        </div>
    </div>
    
    <div id="data-management-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Data Management</h3>
                <button class="close-btn" data-modal="data-management-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="font-size: 0.9rem;">
                    Use this tool to **back up** your study data (Export) or **restore** it on a new device (Import).
                </p>
                
                <h4>Export Data</h4>
                <p style="font-size: 0.9rem; margin-bottom: 10px; color: var(--secondary-text);">
                    Download your full study data as a JSON file for backup.
                </p>
                <button id="export-json-btn">Download Data as JSON</button>
                
                <h4 style="margin-top: 30px;">Import Data</h4>
                <p style="font-size: 0.9rem; margin-bottom: 10px; color: var(--secondary-text);">
                    Upload a previously exported JSON file to restore your data.
                </p>
                <input type="file" id="import-file-input" accept=".json" style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; width: 100%; margin-bottom: 10px;">
                <button id="import-data-btn" style="background-color: var(--danger-color);">Import Data (Overwrite)</button>
                
                <h4 style="margin-top: 30px;">Clear All Data</h4>
                <button id="clear-data-btn" style="background-color: var(--danger-color);">Clear All Local Data</button>
            </div>
        </div>
    </div>
    
    <div id="schedule-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="schedule-modal-date">Daily Schedule</h3>
                <button class="close-btn" data-modal="schedule-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="schedule-summary-banner" class="schedule-summary-banner"></div>
                
                <div id="schedule-modal-content">
                    </div>
                <p id="schedule-empty-message" style="margin-top: 15px; color: var(--secondary-text); font-weight: 500;"></p>
            </div>
        </div>
    </div>
    
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Session</h3>
                <button class="close-btn" data-modal="edit-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-session-form">
                    <input type="hidden" id="edit-session-id">
                    
                    <div class="form-group">
                        <label for="edit-subject">Subject</label>
                        <input type="text" id="edit-subject" list="subject-list" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-topic">Topic</label>
                        <input type="text" id="edit-topic" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-notes">Notes</label>
                        <textarea id="edit-notes"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-file-link">File Link</label>
                        <input type="text" id="edit-file-link">
                    </div>
                    <div class="form-group">
                        <label for="edit-initial-date">Start Date</label>
                        <input type="date" id="edit-initial-date" required>
                        <p style="font-size: 0.8rem; color: var(--danger-color); margin-top: 5px;">
                            Warning: Changing the start date will recalculate all review dates.
                        </p>
                    </div>
                    <button type="submit" id="save-edit-btn">Save Changes</button>
                </form>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONSTANTS & STATE ---
            const REVIEW_INTERVALS = [1, 3, 7, 14, 30, 60, 90]; 
            const DAILY_GOAL = 3;
            
            // Storage Keys
            const STORAGE_KEY = 'studySessions';
            const STORAGE_KEY_LOG = 'studyDailyLog';
            const STORAGE_KEY_STREAK = 'studyStreakState';
            
            // State Variables
            let sessions = [];
            let dailyLog = [];
            let streakState = { streakCount: 0, lastVisit: null, reviewsToday: 0 };
            let currentCalendarDate = new Date();

            // --- DOM SELECTORS ---
            const dateInput = document.getElementById('initial-date');
            const sessionForm = document.getElementById('session-form');
            const subjectInput = document.getElementById('subject');
            const subjectList = document.getElementById('subject-list');
            const topicInput = document.getElementById('topic');
            const notesInput = document.getElementById('notes');
            const fileLinkInput = document.getElementById('file-link');
            
            const navTabs = document.querySelectorAll('.nav-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const todayCountBubble = document.getElementById('today-count-bubble');
            const backlogCountBubble = document.getElementById('backlog-count-bubble');
            
            const todayReviewsContainer = document.getElementById('today-reviews-container');
            const backlogCriticalContainer = document.getElementById('backlog-critical-container');
            const backlogStandardContainer = document.getElementById('backlog-standard-container');
            const allSessionsContainer = document.getElementById('all-sessions-container');
            
            // Subject Filter
            const subjectFilterDropdown = document.getElementById('subject-filter-dropdown');
            
            const globalStatsText = document.getElementById('global-stats-text');
            const globalProgressBarInner = document.getElementById('global-progress-bar-inner');
            const streakCounter = document.getElementById('streak-counter');
            const dailyGoalCounter = document.getElementById('daily-goal-counter');
            const totalTimeCounter = document.getElementById('total-time-counter');
            
            const dailyTimeInput = document.getElementById('daily-time');
            const logTimeBtn = document.getElementById('log-time-btn');
            const loggedTimeToday = document.getElementById('logged-time-today');
            const todayDateLog = document.getElementById('today-date-log');
            
            const detailsModal = document.getElementById('details-modal');
            const dataManagementModal = document.getElementById('data-management-modal');
            
            const modalTopic = document.getElementById('modal-topic');
            const modalNotes = document.getElementById('modal-notes');
            const modalFileLink = document.getElementById('modal-file-link');
            const modalStartDate = document.getElementById('modal-start-date');
            
            const dataManagementBtn = document.getElementById('data-management-btn');
            
            // UPDATED: Data Management Selectors
            const exportJsonBtn = document.getElementById('export-json-btn');
            const importFileInput = document.getElementById('import-file-input');
            const importBtn = document.getElementById('import-data-btn');
            const clearDataBtn = document.getElementById('clear-data-btn');
            
            const calPrevBtn = document.getElementById('cal-prev-btn');
            const calNextBtn = document.getElementById('cal-next-btn');
            const calMonthYear = document.getElementById('cal-month-year');
            const calGrid = document.getElementById('calendar-grid');

            const scheduleModal = document.getElementById('schedule-modal');
            const scheduleModalDate = document.getElementById('schedule-modal-date');
            const scheduleModalContent = document.getElementById('schedule-modal-content');
            const scheduleEmptyMessage = document.getElementById('schedule-empty-message');
            const scheduleSummaryBanner = document.getElementById('schedule-summary-banner');
            
            // Edit Modal Selectors
            const editModal = document.getElementById('edit-modal');
            const editSessionForm = document.getElementById('edit-session-form');
            const editSessionId = document.getElementById('edit-session-id');
            const editSubject = document.getElementById('edit-subject');
            const editTopic = document.getElementById('edit-topic');
            const editNotes = document.getElementById('edit-notes');
            const editFileLink = document.getElementById('edit-file-link');
            const editInitialDate = document.getElementById('edit-initial-date');


            // --- DATE HELPERS ---
            const formatDate = (date) => {
                const d = new Date(date);
                const offset = d.getTimezoneOffset();
                const adjustedDate = new Date(d.getTime() - (offset * 60 * 1000));
                return adjustedDate.toISOString().split('T')[0];
            };

            const getTodayString = () => {
                return formatDate(new Date());
            };

            const calculateReviewDates = (initialDateStr) => {
                const startDate = new Date(initialDateStr + 'T00:00:00');
                return REVIEW_INTERVALS.map(days => {
                    const reviewDate = new Date(startDate.getTime());
                    reviewDate.setDate(reviewDate.getDate() + days); 
                    return formatDate(reviewDate);
                });
            };

            // --- LOCAL STORAGE ---
            const loadSessions = () => {
                try {
                    const sessionsJSON = localStorage.getItem(STORAGE_KEY);
                    sessions = sessionsJSON ? JSON.parse(sessionsJSON) : [];
                    if (!Array.isArray(sessions)) {
                         sessions = [];
                         console.error("Loaded data was not an array. Resetting sessions.");
                    }
                } catch (error) {
                    console.error("Error loading sessions from localStorage:", error);
                    sessions = [];
                }
            };

            const saveSessions = () => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
            };
            
            const loadDailyLog = () => {
                try {
                    const logJSON = localStorage.getItem(STORAGE_KEY_LOG);
                    dailyLog = logJSON ? JSON.parse(logJSON) : [];
                    if (!Array.isArray(dailyLog)) dailyLog = [];
                } catch (e) { 
                    console.error("Error loading daily log:", e);
                    dailyLog = []; 
                }
            };
            
            const saveDailyLog = () => {
                localStorage.setItem(STORAGE_KEY_LOG, JSON.stringify(dailyLog));
            };
            
            const loadStreakState = () => {
                try {
                    const streakJSON = localStorage.getItem(STORAGE_KEY_STREAK);
                    const loadedState = streakJSON ? JSON.parse(streakJSON) : {};
                    const today = getTodayString();
                    const yesterday = formatDate(new Date(Date.now() - 86400000));

                    streakState = {
                        streakCount: loadedState.streakCount || 0,
                        lastVisit: loadedState.lastVisit || null,
                        reviewsToday: loadedState.reviewsToday || 0
                    };
                    
                    if (streakState.lastVisit === today) {
                        // Already visited today
                    } else if (streakState.lastVisit === yesterday) {
                        // Visited yesterday. Check if goal was met.
                        if (streakState.reviewsToday >= DAILY_GOAL) {
                            streakState.streakCount++;
                        } else {
                            streakState.streakCount = 1; // Reset streak
                        }
                        streakState.lastVisit = today;
                        streakState.reviewsToday = 0; 
                    } else {
                        // Missed a day or first visit
                        streakState.streakCount = 1; 
                        if (!streakState.lastVisit) streakState.streakCount = 0; 
                        streakState.lastVisit = today;
                        streakState.reviewsToday = 0;
                    }

                } catch (e) {
                    console.error("Error loading streak state:", e);
                    streakState = { streakCount: 0, lastVisit: getTodayString(), reviewsToday: 0 };
                }
                saveStreakState();
            };
            
            const saveStreakState = () => {
                localStorage.setItem(STORAGE_KEY_STREAK, JSON.stringify(streakState));
            };
            
            
            // --- DATA HELPERS (Datalists & Filters) ---
            const updateSubjectDatalist = () => {
                const subjects = [...new Set(sessions.map(s => s.subject ? s.subject.trim() : "")
                                                    .filter(s => s && s !== "Uncategorized"))].sort();
                subjectList.innerHTML = '';
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    subjectList.appendChild(option);
                });
            };
            
            // Populate Subject Filter Dropdown
            const populateSubjectFilter = () => {
                const currentVal = subjectFilterDropdown.value;
                const subjects = [...new Set(sessions.map(s => (s.subject || "Uncategorized").trim()))].sort((a, b) => {
                    if (a === "Uncategorized") return 1;
                    if (b === "Uncategorized") return -1;
                    return a.localeCompare(b);
                });
                
                subjectFilterDropdown.innerHTML = '<option value="all">Show All</option>'; // Reset
                
                subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectFilterDropdown.appendChild(option);
                });
                
                // Restore selection if possible
                if (Array.from(subjectFilterDropdown.options).some(opt => opt.value === currentVal)) {
                    subjectFilterDropdown.value = currentVal;
                } else {
                    subjectFilterDropdown.value = 'all';
                }
            };
            
            // --- TAB SWITCHING & UI ---
            const handleTabClick = (e) => {
                const clickedTab = e.currentTarget;
                const tabTarget = clickedTab.dataset.tab;
                
                navTabs.forEach(tab => tab.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                
                clickedTab.classList.add('active');
                document.getElementById(`tab-${tabTarget}`).classList.add('active');
                
                if (tabTarget === 'attendance') {
                    renderCalendar(currentCalendarDate);
                }
            };
            
            // --- MODAL LOGIC ---
            const showModal = (modalElement, sessionId = null) => {
                // This function is now multipurpose.
                // If it's the details modal, populate it.
                if (modalElement.id === 'details-modal' && sessionId) {
                    const session = sessions.find(s => s.id === sessionId);
                    if (!session) return;
                    
                    const subject = session.subject || "Uncategorized";
                    modalTopic.innerHTML = `<span style="color: var(--primary-text); font-size: 1.1rem; display: block;">${subject}</span>${session.topic}`;
                    modalNotes.textContent = session.notes || '(No notes added)';
                    modalStartDate.textContent = session.initialDate;
                    
                    if (session.fileLink) {
                        modalFileLink.innerHTML = `<a href="${session.fileLink}" target="_blank" rel="noopener noreferrer">${session.fileLink}</a>`;
                    } else {
                        modalFileLink.innerHTML = `<p>(No file link provided)</p>`;
                    }
                }
                
                modalElement.style.display = 'block';
            };
            
            const closeModal = (modalElement) => {
                modalElement.style.display = 'none';
            };
            
            // Open and populate the Edit Modal
            const openEditModal = (sessionId) => {
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;
                
                editSessionId.value = session.id;
                editSubject.value = session.subject;
                editTopic.value = session.topic;
                editNotes.value = session.notes;
                editFileLink.value = session.fileLink;
                editInitialDate.value = session.initialDate;
                
                showModal(editModal);
            };
            
            // --- CALENDAR LOGIC ---
            const getReviewsForDate = (dateString) => {
                let isCompleted = false;
                let reviewsDueCount = 0;

                sessions.forEach(session => {
                    if (session.completedReviews.includes(dateString)) {
                        isCompleted = true;
                    }
                    if (session.reviewDates.includes(dateString) && !session.completedReviews.includes(dateString)) {
                        reviewsDueCount++;
                    }
                });
                return { isCompleted, isDue: reviewsDueCount > 0, reviewsDueCount };
            };

            const renderCalendar = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                
                const monthName = date.toLocaleString('default', { month: 'long' });
                calMonthYear.textContent = `${monthName} ${year}`;

                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const today = getTodayString();
                const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];

                let gridHTML = dayNames.map(name => `<div class="calendar-day-name">${name}</div>`).join('');
                
                const startDay = (firstDayOfMonth.getDay() + 6) % 7; // Monday is 0

                for (let i = 0; i < startDay; i++) {
                    gridHTML += '<div class="calendar-date-cell"></div>';
                }

                for (let d = 1; d <= lastDayOfMonth.getDate(); d++) {
                    const dateString = formatDate(new Date(year, month, d));
                    const reviewData = getReviewsForDate(dateString);
                    
                    let classes = 'calendar-date-cell';
                    let attributes = `title="${dateString}"`; 
                    
                    if (dateString === today) classes += ' today';
                    if (reviewData.isCompleted) classes += ' completed';
                    
                    if (reviewData.reviewsDueCount > 0) classes += ' due-revision';
                    if (reviewData.reviewsDueCount > 5) classes += ' due-intensity-high';

                    gridHTML += `<div class="${classes}" ${attributes}>${d}</div>`;
                }
                
                calGrid.innerHTML = gridHTML;
            };

            const navigateCalendar = (direction) => {
                if (direction === 'prev') {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                } else if (direction === 'next') {
                    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                }
                renderCalendar(currentCalendarDate);
            };
            
            const showDailySchedule = (dateString) => {
                const dueTasks = [];
                const today = getTodayString();
                
                scheduleSummaryBanner.style.display = 'none';
                const logEntry = dailyLog.find(entry => entry.date === dateString);
                if (logEntry) {
                    scheduleSummaryBanner.innerHTML = `Summary for ${dateString}: Logged <strong>${logEntry.minutes}</strong> minutes. <strong>${logEntry.reviewsCompleted}</strong> reviews completed.`;
                    scheduleSummaryBanner.style.display = 'block';
                } else if (dateString < today) {
                    scheduleSummaryBanner.innerHTML = `Summary for ${dateString}: <strong>0</strong> minutes logged. <strong>0</strong> reviews completed.`;
                    scheduleSummaryBanner.style.display = 'block';
                }

                sessions.forEach(session => {
                    if (session.reviewDates.includes(dateString) && !session.completedReviews.includes(dateString)) {
                        dueTasks.push({
                            sessionId: session.id,
                            subject: session.subject || "Uncategorized",
                            topic: session.topic,
                            reviewDate: dateString,
                            isOverdue: dateString < today 
                        });
                    }
                });

                scheduleModalDate.textContent = `Scheduled Reviews for ${dateString}`;
                
                if (dueTasks.length > 0) {
                    scheduleEmptyMessage.textContent = `Total ${dueTasks.length} task(s) found. Check the boxes to complete them.`;
                    dueTasks.sort((a, b) => a.subject.localeCompare(b.subject));
                    scheduleModalContent.innerHTML = dueTasks.map(task => 
                        `<div class="review-item ${task.isOverdue ? 'overdue' : ''}">
                            ${createReviewItemHTML(task)}
                        </div>`
                    ).join('');
                } else {
                    scheduleModalContent.innerHTML = '<p class="empty-state" style="padding: 10px; border: 1px dashed var(--border-color);">No scheduled revisions for this date.</p>';
                    scheduleEmptyMessage.textContent = '';
                }
                
                showModal(scheduleModal);
            };

            // --- RENDER FUNCTIONS (UI updates) ---
            const updateGlobalUIElements = (todayTasks, backlogTasks) => {
                let totalReviews = 0;
                let completedReviews = 0;
                sessions.forEach(session => {
                    totalReviews += session.reviewDates.length;
                    completedReviews += session.completedReviews.length;
                });
                const globalProgressPercent = totalReviews > 0 ? (completedReviews / totalReviews) * 100 : 0;
                
                globalStatsText.textContent = `Total Progress: ${completedReviews} / ${totalReviews} Reviews`;
                globalProgressBarInner.style.width = `${globalProgressPercent}%`;
                
                todayCountBubble.textContent = todayTasks.length;
                todayCountBubble.style.display = todayTasks.length > 0 ? 'grid' : 'none';
                
                backlogCountBubble.textContent = backlogTasks.length;
                backlogCountBubble.style.display = backlogTasks.length > 0 ? 'grid' : 'none';
                
                const totalMinutes = dailyLog.reduce((sum, entry) => sum + (entry.minutes || 0), 0);
                const totalHours = (totalMinutes / 60).toFixed(1);
                
                streakCounter.textContent = `ðŸ”¥ Streak: ${streakState.streakCount}`;
                dailyGoalCounter.textContent = `Reviews Today: ${streakState.reviewsToday} / ${DAILY_GOAL}`;
                totalTimeCounter.textContent = `ðŸ•’ Total Study Time: ${totalHours} Hours`;
                
                const today = getTodayString();
                todayDateLog.textContent = today;
                const todayLogEntry = dailyLog.find(entry => entry.date === today);
                loggedTimeToday.textContent = todayLogEntry ? todayLogEntry.minutes : 0;
            };

            const renderApp = () => {
                const today = getTodayString();
                let todayTasks = [];
                let backlogTasks = [];

                sessions.forEach(session => {
                    session.reviewDates.forEach(reviewDate => {
                        if (!session.completedReviews.includes(reviewDate)) {
                            const task = {
                                sessionId: session.id,
                                subject: session.subject || "Uncategorized",
                                topic: session.topic,
                                reviewDate: reviewDate
                            };
                            if (reviewDate === today) {
                                todayTasks.push(task);
                            } else if (reviewDate < today) {
                                task.isOverdue = true;
                                const daysOverdue = (new Date(today) - new Date(reviewDate)) / (1000 * 60 * 60 * 24);
                                task.isCritical = daysOverdue > 30;
                                backlogTasks.push(task);
                            }
                        }
                    });
                });
                
                renderTodayReviews(todayTasks);
                renderBacklogReviews(backlogTasks);
                renderAllSessions(); 
                updateGlobalUIElements(todayTasks, backlogTasks);
                updateSubjectDatalist();
                
                if (document.getElementById('tab-attendance').classList.contains('active')) {
                     renderCalendar(currentCalendarDate);
                }
            };
            
            const createReviewItemHTML = (task) => {
                return `
                    <div class="review-item-info">
                        <strong>${task.subject}</strong>
                        <div class="topic-name">${task.topic}</div>
                        <div class="review-date">
                            Due: ${task.reviewDate}
                            ${task.isOverdue ? '<span style="color: var(--overdue-color); font-weight: 600;"> (Overdue)</span>' : ''}
                        </div>
                    </div>
                    <div class="review-item-actions">
                        <button class="details-btn" data-session-id="${task.sessionId}">&#8942;</button>
                        <input type="checkbox" data-session-id="${task.sessionId}" data-review-date="${task.reviewDate}">
                    </div>
                `;
            };

            const renderTodayReviews = (tasks) => {
                tasks.sort((a, b) => a.subject.localeCompare(b.subject));
                todayReviewsContainer.innerHTML = tasks.length === 0 
                    ? '<p class="empty-state">No reviews due today. Great job! ðŸŽ‰</p>' 
                    : tasks.map(task => `<div class="review-item">${createReviewItemHTML(task)}</div>`).join('');
            };
            
            const renderBacklogReviews = (tasks) => {
                const criticalTasks = tasks.filter(t => t.isCritical);
                const standardTasks = tasks.filter(t => !t.isCritical);
                
                criticalTasks.sort((a, b) => new Date(a.reviewDate) - new Date(b.reviewDate));
                standardTasks.sort((a, b) => new Date(a.reviewDate) - new Date(b.reviewDate));
                
                backlogCriticalContainer.innerHTML = criticalTasks.length === 0 
                    ? '<p class="empty-state" style="padding: 10px; border: none;">No critical items. Phew!</p>' 
                    : criticalTasks.map(task => `<div class="review-item overdue critical">${createReviewItemHTML(task)}</div>`).join('');
                
                backlogStandardContainer.innerHTML = standardTasks.length === 0 
                    ? '<p class="empty-state" style="padding: 10px; border: none;">No standard backlog items.</p>' 
                    : standardTasks.map(task => `<div class="review-item overdue">${createReviewItemHTML(task)}</div>`).join('');
            };
            
            // To handle subject filtering
            const renderAllSessions = () => {
                // 1. Populate/update the filter dropdown first
                populateSubjectFilter();
                
                // 2. Get the currently selected subject
                const selectedSubject = subjectFilterDropdown.value;
                
                allSessionsContainer.innerHTML = '';
                if (sessions.length === 0) {
                    allSessionsContainer.innerHTML = '<p class="empty-state">No study sessions logged yet. Add one to get started!</p>';
                    return;
                }

                const subjectGroups = {};
                sessions.forEach(session => {
                    const subject = (session.subject || "Uncategorized").trim();
                    if (!subjectGroups[subject]) { subjectGroups[subject] = []; }
                    subjectGroups[subject].push(session);
                });

                const sortedSubjectNames = Object.keys(subjectGroups).sort((a, b) => {
                    if (a === "Uncategorized") return 1;
                    if (b === "Uncategorized") return -1;
                    return a.localeCompare(b);
                });

                let sessionsFound = false;
                sortedSubjectNames.forEach(subjectName => {
                    // 3. Check if this subject should be rendered
                    if (selectedSubject !== 'all' && subjectName !== selectedSubject) {
                        return; // Skip this subject
                    }
                    sessionsFound = true;

                    const sessionsInSubject = subjectGroups[subjectName];
                    const totalInSubject = sessionsInSubject.length;
                    const masteredInSubject = sessionsInSubject.filter(s => 
                        s.completedReviews.length === s.reviewDates.length && s.reviewDates.length > 0
                    ).length;
                    
                    const subjectHeader = document.createElement('h3');
                    subjectHeader.className = 'subject-group-header';
                    subjectHeader.innerHTML = `${subjectName} <span class="subject-scoreboard">${masteredInSubject} / ${totalInSubject} Mastered</span>`;
                    allSessionsContainer.appendChild(subjectHeader);

                    subjectGroups[subjectName].sort((a, b) => b.id - a.id).forEach(session => {
                        const card = document.createElement('div');
                        card.className = 'session-card';

                        const completedCount = session.completedReviews.length;
                        const totalCount = session.reviewDates.length;
                        const progressPercent = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
                        
                        const isMastered = completedCount === REVIEW_INTERVALS.length;
                        if (isMastered) {
                            card.classList.add('mastered');
                        }

                        const sortedCompleted = [...session.completedReviews].sort((a, b) => new Date(a) - new Date(b));

                        const completedListHTML = sortedCompleted.map(date => {
                            return `<li>
                                        <span>âœ… ${date}</span>
                                        <button class="undo-btn" data-session-id="${session.id}" data-review-date="${date}">Undo</button>
                                    </li>`;
                        }).join('');

                        card.innerHTML = `
                            <h3>${session.topic}</h3>
                            <p><strong>Started:</strong> ${session.initialDate}</p>
                            ${session.notes ? `<p><strong>Notes:</strong>\n${session.notes.substring(0, 100) + (session.notes.length > 100 ? '...' : '')}</p>` : ''}
                            
                            <h4>Mastery Level:</h4> 
                            <div class="progress-bar">
                                <div class="progress-bar-inner" style="width: ${progressPercent}%;"></div>
                            </div>
                            
                            ${completedListHTML.length > 0 ? '<h5>Completed Reviews:</h5>' : ''}
                            <ul class="completed-reviews-list">
                                ${completedListHTML}
                            </ul>
                            
                            <div class="session-footer">
                                <span class="progress-text">Progress: ${completedCount} / ${totalCount}</span>
                                <div>
                                    <button class="edit-btn" data-session-id="${session.id}">Edit</button>
                                    <button class="delete-btn" data-session-id="${session.id}">Delete</button>
                                </div>
                            </div>
                        `;
                        
                        const masteryTitle = card.querySelector('h4');
                        masteryTitle.textContent = `Mastery: ${completedCount} / ${totalCount} Levels`;
                        
                        allSessionsContainer.appendChild(card);
                    });
                });
                
                if (!sessionsFound && selectedSubject !== 'all') {
                     allSessionsContainer.innerHTML = `<p class="empty-state">No sessions found for the subject "${selectedSubject}".</p>`;
                }
            };

            // --- CORE EVENT HANDLERS ---
            const handleFormSubmit = (e) => {
                e.preventDefault();
                const subject = subjectInput.value.trim();
                const topic = topicInput.value.trim();
                if (!subject || !topic || !dateInput.value) { return; }
                
                const newSession = {
                    id: Date.now(),
                    subject: subject,
                    topic: topic,
                    notes: notesInput.value.trim(),
                    fileLink: fileLinkInput.value.trim(),
                    initialDate: dateInput.value,
                    reviewDates: calculateReviewDates(dateInput.value),
                    completedReviews: []
                };

                sessions.push(newSession);
                saveSessions();
                renderApp();
                sessionForm.reset();
                dateInput.value = getTodayString();
                document.querySelector('.nav-tab[data-tab="all"]').click();
            };
            
            // Handle Edit Form Submit
            const handleEditFormSubmit = (e) => {
                e.preventDefault();
                
                const sessionId = parseInt(editSessionId.value, 10);
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;
                
                const oldInitialDate = session.initialDate;
                const newInitialDate = editInitialDate.value;
                
                // Update session properties
                session.subject = editSubject.value.trim();
                session.topic = editTopic.value.trim();
                session.notes = editNotes.value.trim();
                session.fileLink = editFileLink.value.trim();
                session.initialDate = newInitialDate;
                
                // Check if start date changed, if so, recalculate reviews
                if (oldInitialDate !== newInitialDate) {
                    session.reviewDates = calculateReviewDates(newInitialDate);
                    // Completed reviews are kept, which is a reasonable approach for editing
                }
                
                saveSessions();
                renderApp();
                closeModal(editModal);
            };
            
            const handleTimeLog = () => {
                const minutes = parseInt(dailyTimeInput.value, 10);
                if (isNaN(minutes) || minutes <= 0) {
                    alert('Please enter a valid number of minutes.');
                    return;
                }
                
                const today = getTodayString();
                let logEntry = dailyLog.find(entry => entry.date === today);
                
                if (logEntry) {
                    logEntry.minutes += minutes;
                } else {
                    logEntry = {
                        date: today,
                        minutes: minutes,
                        reviewsCompleted: streakState.reviewsToday
                    };
                    dailyLog.push(logEntry);
                }
                
                dailyTimeInput.value = '';
                saveDailyLog();
                renderApp();
            };

            const handleReviewCompletion = (e) => {
                const checkbox = e.target;
                const sessionId = parseInt(checkbox.dataset.sessionId, 10);
                const reviewDate = checkbox.dataset.reviewDate;
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;

                if (checkbox.checked) {
                    if (!session.completedReviews.includes(reviewDate)) {
                        session.completedReviews.push(reviewDate);
                    }
                } else {
                    session.completedReviews = session.completedReviews.filter(date => date !== reviewDate);
                }
                saveSessions();
                
                const today = getTodayString();
                if (reviewDate === today) {
                    const oldReviewsToday = streakState.reviewsToday;
                    
                    if (checkbox.checked) {
                        streakState.reviewsToday++;
                    } else {
                        streakState.reviewsToday = Math.max(0, streakState.reviewsToday - 1);
                    }
                    
                    if (oldReviewsToday < DAILY_GOAL && streakState.reviewsToday >= DAILY_GOAL) {
                        if (streakState.streakCount === 0) {
                            streakState.streakCount = 1;
                        }
                    }
                }
                
                let logEntry = dailyLog.find(entry => entry.date === today);
                if (logEntry) {
                    logEntry.reviewsCompleted = streakState.reviewsToday;
                } else if (reviewDate === today || e.target.closest('#tab-today')) {
                    dailyLog.push({
                        date: today,
                        minutes: 0,
                        reviewsCompleted: streakState.reviewsToday
                    });
                }
                
                saveStreakState();
                saveDailyLog();
                
                renderApp();
                
                if(scheduleModal.style.display === 'block' && scheduleModalDate.textContent.includes(reviewDate)) {
                    showDailySchedule(reviewDate); 
                }
            };
            
            const handleUndoCompletion = (e) => {
                const sessionId = parseInt(e.target.dataset.sessionId, 10);
                const reviewDate = e.target.dataset.reviewDate;
                const session = sessions.find(s => s.id === sessionId);
                if (!session) return;
                
                session.completedReviews = session.completedReviews.filter(date => date !== reviewDate);
                saveSessions();
                
                const today = getTodayString();
                if (reviewDate === today) {
                    streakState.reviewsToday = Math.max(0, streakState.reviewsToday - 1);
                    
                    let logEntry = dailyLog.find(entry => entry.date === today);
                    if (logEntry) {
                        logEntry.reviewsCompleted = streakState.reviewsToday;
                    }
                    saveStreakState();
                    saveDailyLog();
                }
                
                renderApp();
            };

            const handleDeleteSession = (e) => {
                const button = e.target.closest('.delete-btn');
                if (!button) return;
                
                if (!confirm('Are you sure you want to delete this entire session? This action cannot be undone.')) return;
                
                const sessionId = parseInt(button.dataset.sessionId, 10);
                sessions = sessions.filter(s => s.id !== sessionId);
                saveSessions();
                renderApp();
            };

            // --- Data Management (Export/Import) Handlers ---

            // Helper to download JSON file
            const downloadJSON = (data, filename) => {
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // Export logic
            const handleExportData = () => {
                const exportData = {
                    sessions: sessions,
                    dailyLog: dailyLog,
                    streakState: streakState
                };
                const today = getTodayString();
                downloadJSON(exportData, `study_tracker_data_backup_${today}.json`);
            };

            const openDataManagement = () => {
                // Reset file input when opening modal
                importFileInput.value = '';
                showModal(dataManagementModal);
            };

            // Import logic
            const handleImportData = () => {
                const file = importFileInput.files[0];
                
                if (!file) {
                    alert('Please select a JSON file to import first.');
                    return;
                }

                if (!confirm('Importing will overwrite ALL of your current study data, logs, and streaks. Are you absolutely sure?')) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = (event) => {
                    const dataString = event.target.result;
                    try {
                        const importedData = JSON.parse(dataString);
                        
                        if (Array.isArray(importedData)) {
                            // Old format compatibility
                            sessions = importedData;
                            dailyLog = [];
                            streakState = { streakCount: 0, lastVisit: getTodayString(), reviewsToday: 0 };
                            alert('Old data format imported successfully! Logs and streaks have been reset.');
                        } else if (importedData.sessions && importedData.dailyLog && importedData.streakState) {
                            // New format import
                            sessions = importedData.sessions;
                            dailyLog = importedData.dailyLog;
                            streakState = importedData.streakState;
                            alert('Data imported successfully!');
                        } else {
                            throw new Error('File structure is invalid or corrupted.');
                        }

                        saveSessions();
                        saveDailyLog();
                        saveStreakState();
                        
                        loadStreakState(); 
                        renderApp();
                        closeModal(dataManagementModal);
                        
                    } catch (error) {
                        console.error("Import Error:", error);
                        alert(`Import failed. The file is not a valid JSON file. Error: ${error.message}`);
                    }
                };
                
                reader.onerror = () => {
                    alert('Error reading file. Please try again.');
                };

                reader.readAsText(file);
            };
            
            const handleClearData = () => {
                if (confirm('DANGER! This will delete ALL study data, logs, and streaks permanently. Are you absolutely sure?')) {
                    sessions = [];
                    dailyLog = [];
                    streakState = { streakCount: 0, lastVisit: getTodayString(), reviewsToday: 0 };
                    
                    localStorage.removeItem(STORAGE_KEY);
                    localStorage.removeItem(STORAGE_KEY_LOG);
                    localStorage.removeItem(STORAGE_KEY_STREAK);
                    
                    renderApp();
                    closeModal(dataManagementModal);
                    alert('All data has been cleared.');
                }
            };
            
            // --- INITIALIZATION ---
            const init = () => {
                dateInput.value = getTodayString();
                
                // Event Listeners setup
                sessionForm.addEventListener('submit', handleFormSubmit);
                navTabs.forEach(tab => tab.addEventListener('click', handleTabClick));
                
                calPrevBtn.addEventListener('click', () => navigateCalendar('prev'));
                calNextBtn.addEventListener('click', () => navigateCalendar('next'));
                
                calGrid.addEventListener('click', (e) => {
                    const dateCell = e.target.closest('.calendar-date-cell');
                    if (dateCell && dateCell.title) {
                        showDailySchedule(dateCell.title);
                    }
                });

                dataManagementBtn.addEventListener('click', openDataManagement);
                // UPDATED: Export to file
                exportJsonBtn.addEventListener('click', handleExportData); 
                // UPDATED: Import from file
                importBtn.addEventListener('click', handleImportData);
                clearDataBtn.addEventListener('click', handleClearData);
                
                logTimeBtn.addEventListener('click', handleTimeLog);
                
                // Listeners for filter and edit
                subjectFilterDropdown.addEventListener('change', renderAllSessions);
                editSessionForm.addEventListener('submit', handleEditFormSubmit);

                // Global Action Listeners (delegated)
                document.body.addEventListener('click', (e) => {
                    const closeButton = e.target.closest('.close-btn');
                    if (closeButton && closeButton.dataset.modal) { 
                        closeModal(document.getElementById(closeButton.dataset.modal)); 
                        return;
                    }
                    
                    const detailsButton = e.target.closest('.details-btn');
                    if (detailsButton && detailsButton.dataset.sessionId) {
                        showModal(detailsModal, parseInt(detailsButton.dataset.sessionId, 10));
                        return;
                    }
                    
                    const deleteButton = e.target.closest('.delete-btn');
                    if (deleteButton && deleteButton.dataset.sessionId) {
                        handleDeleteSession(e);
                        return;
                    }

                    const undoButton = e.target.closest('.undo-btn');
                    if (undoButton && undoButton.dataset.sessionId) {
                        handleUndoCompletion(e);
                        return;
                    }
                    
                    // Edit button listener
                    const editButton = e.target.closest('.edit-btn');
                    if (editButton && editButton.dataset.sessionId) {
                        openEditModal(parseInt(editButton.dataset.sessionId, 10));
                        return;
                    }
                });
                
                document.body.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox' && e.target.dataset.sessionId) { 
                        handleReviewCompletion(e); 
                    }
                });
                
                window.addEventListener('click', (e) => {
                    if (e.target == detailsModal) { closeModal(detailsModal); }
                    if (e.target == dataManagementModal) { closeModal(dataManagementModal); }
                    if (e.target == scheduleModal) { closeModal(scheduleModal); }
                    if (e.target == editModal) { closeModal(editModal); } 
                });

                // Initial load
                loadDailyLog();
                loadStreakState();
                loadSessions();
                renderApp(); 
            };

            init();
        });
    </script>

</body>
</html>
